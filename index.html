<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<title>MyGroup Kredit</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
body{margin:0;padding:20px;font-family:Arial;background:#f4f6f9}
h1{margin:0 0 8px;font-size:20px}
.card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:16px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.kpi{border:1px solid #eee;border-radius:10px;padding:12px}
.kpi .l{font-size:12px;color:#6b7280}
.kpi .v{font-size:18px;font-weight:bold;margin-top:6px}
.experts{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.expert{border:1px solid #eee;border-radius:10px;padding:12px;font-size:14px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:8px;text-align:left}
th{color:#6b7280}
#targetPie{max-width:240px;max-height:240px;margin:0 auto;display:block}

.kpi.green{background:#ecfdf5;border-color:#10b981}
.kpi.yellow{background:#fffbeb;border-color:#f59e0b}
.kpi.red{background:#fef2f2;border-color:#ef4444}

.badge{display:inline-block;padding:2px 8px;font-size:12px;border-radius:999px;margin-left:6px}
.badge.top{background:#fff7ed;border:1px solid #fdba74}

#dashboard{max-width:1100px;margin:0 auto}

/* ≈üirk…ôt c…ôdv…ôli √º√ß√ºn scroll */
.table-wrap{width:100%;overflow-x:auto}
/* ===== TOP ACTION BUTTONS ===== */
.top-actions{
  position: fixed;
  top: 12px;
  right: 12px;
  display: flex;
  gap: 8px;
  z-index: 9999;
}

.top-actions button{
  border:1px solid #e5e7eb;
  background:#fff;
  border-radius:10px;
  padding:8px 12px;
  cursor:pointer;
  font-size:13px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

.top-actions button:hover{
  background:#f8fafc;
}
/* ===== MOBILE FIXES ===== */
@media (max-width: 768px){

  body{
    padding:10px;
    overflow-x:hidden;
  }

  #dashboard{
    max-width:100%;
  }

  h1{
    font-size:18px;
  }

  .kpis{
    grid-template-columns:repeat(2,1fr); /* 4 -> 2 */
  }

  .experts{
    grid-template-columns:1fr; /* 3 -> 1 */
  }

  .expert{
    font-size:13px;
    line-height:1.5;
  }

  .kpi .v{
    font-size:15px;
    word-break:break-word;
  }

  table{
    font-size:13px;
    min-width:520px; /* scroll i≈ül…ôsin */
  }

  .table-wrap{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }

  #targetPie{
    max-width:200px;
    max-height:200px;
  }

  /* TOP BUTTONS ‚Äì mobil √º√ß√ºn yƒ±ƒücam */
  .top-actions{
    top:8px;
    right:8px;
    gap:6px;
  }

  .top-actions button{
    padding:6px 8px;
    font-size:12px;
  }
}
/* ===== COLLAPSE CARDS ===== */
.card h3{
  cursor:pointer;
  user-select:none;
}

.card-body{
  margin-top:8px;
}

.card.collapsed .card-body{
  display:none;
}

</style>
</head>

<body>
<div class="top-actions">
  <button id="btnRefresh">üîÑ Yenil…ô</button>
  <button id="btnPNG">üì§ PNG</button>
  <button id="btnPDF">üìÑ PDF</button>
</div>


<div id="dashboard">
  <h1>MyGroup Kredit</h1>
  <p>Tarix: <b id="today"></b> <span id="lastUpdate" style="color:#6b7280"></span></p>

  <div class="card">
    <h3>Portfel g√∂st…ôricil…ôri</h3>
    <div class="card-body">
     <div class="kpis" id="mainKpi"></div>
     </div>
  </div>

  <div class="card">
    <h3>Satƒ±≈ü</h3>
    <div class="card-body">
    <div class="kpis" id="salesKpi"></div>
    </div>
  </div>

  <div class="card">
    <h3>M√ºt…ôx…ôssis satƒ±≈üƒ±</h3>
    <div class="card-body">
    <div class="experts" id="experts"></div>
    </div>
  </div>

  <div class="card">
    <h3>√úmumi h…ôd…ôf icrasƒ±</h3>
    <div class="card-body">
    <div style="text-align:center">
      <div id="totalPercent" style="font-size:26px;font-weight:800"></div>
      <div>√úmumi h…ôd…ôf: <b id="totalTargetText"></b></div>
      <canvas id="targetPie"></canvas>
    </div>
    </div>
  </div>

  <!-- ≈ûirk…ôtl…ôr √ºzr…ô portfel (dashboard-un ƒ∞√áƒ∞ND∆è) -->
  <div class="card">
    <h3>≈ûirk…ôtl…ôr √ºzr…ô portfel</h3>
    <div class="card-body">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>≈ûirk…ôt</th>
            <th>Aktiv portfel</th>
            <th>PAR30+</th>
          </tr>
        </thead>
        <tbody id="companyTable"></tbody>
      </table>
    </div>
    </div>
  </div>
</div>

<script>
const SHEET="https://opensheet.elk.sh/17qXOuePLlCtB8Z-J5e7xISkJ0VybGuAVZSxPTXq4ilc/Sheet5";
document.getElementById("today").innerText = new Date().toLocaleDateString("az-AZ");

let pieChart=null;

function toNum(x){
  if(x === null || x === undefined) return 0;
  const s = String(x).replace(/\s/g,'').replace(/,/g,'').replace('%','');
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}

async function loadData(){
  const rows = await fetch(SHEET,{cache:"no-store"}).then(r=>r.json());
  const d = rows[0] || {};

  document.getElementById("lastUpdate").innerText =
    " ¬∑ " + new Date().toLocaleTimeString("az-AZ");

  const monthlyCollection = toNum(d.MonthlyExpectedCollection);
  const avgTerm = toNum(d.WeightedAverageTerm);

  const diff = toNum(d.PortfolioDiff);
  const icon = diff>0?"‚¨ÜÔ∏è":diff<0?"‚¨áÔ∏è":"‚ûñ";

  // PORTFEL KPI
  document.getElementById("mainKpi").innerHTML = `
    <div class="kpi">
      <div class="l">Portfel</div>
      <div class="v">${toNum(d.Portfolio).toLocaleString()} AZN (${icon} ${Math.abs(diff)}%)</div>
    </div>
    <div class="kpi"><div class="l">PAR30+</div><div class="v">${d.Par30 ?? "-"}</div></div>
    <div class="kpi"><div class="l">Marja</div><div class="v">${d.Marja ?? "-"}</div></div>
    <div class="kpi"><div class="l">Aylƒ±q orta yƒ±ƒüƒ±m</div><div class="v">${monthlyCollection.toLocaleString()} AZN</div></div>
    <div class="kpi"><div class="l">Orta kredit m√ºdd…ôti</div><div class="v">${avgTerm.toFixed(3)} ay</div></div>
  `;

  // KPI r…ôngl…ôri (portfel + par30)
  const kpis = document.querySelectorAll("#mainKpi .kpi");
  if(kpis[0]){
    if(diff >= 5) kpis[0].classList.add("green");
    else if(diff >= 0) kpis[0].classList.add("yellow");
    else kpis[0].classList.add("red");
  }
  const par = toNum(d.Par30);
  if(kpis[1]){
    if(par <= 3) kpis[1].classList.add("green");
    else if(par <= 6) kpis[1].classList.add("yellow");
    else kpis[1].classList.add("red");
  }

  // SATI≈û KPI
  document.getElementById("salesKpi").innerHTML = `
    <div class="kpi"><div class="l">Hiss…ôli √∂d…ôni≈ü</div><div class="v">${toNum(d.InstallmentAmount).toLocaleString()} AZN</div></div>
    <div class="kpi"><div class="l">ƒ∞lkin √∂d…ôni≈ü</div><div class="v">${toNum(d.FirstPayment).toLocaleString()} AZN</div></div>
    <div class="kpi"><div class="l">√úmumi m…ôbl…ôƒü</div><div class="v">${toNum(d.TotalAmount).toLocaleString()} AZN</div></div>
  `;

  // M√úT∆èX∆èSSƒ∞S
  const experts=[
    {n:d.Expert1,s:d.ExpertSale1,c:d.ExpertCount1,t:d.ExpertTarget1,p:d.ExpertPar1,h:toNum(d.Expert1Target)},
    {n:d.Expert2,s:d.ExpertSale2,c:d.ExpertCount2,t:d.ExpertTarget2,p:d.ExpertPar2,h:toNum(d.Expert2Target)},
    {n:d.Expert3,s:d.ExpertSale3,c:d.ExpertCount3,t:d.ExpertTarget3,p:d.ExpertPar3,h:toNum(d.Expert3Target)}
  ];

  const salesVals = experts.map(e=>toNum(e.s));
  const topIdx = salesVals.indexOf(Math.max(...salesVals));

  document.getElementById("experts").innerHTML = experts.map((e,i)=>`
    <div class="expert">
      <b>${e.n || "-"}</b>
      ${i===topIdx ? `<span class="badge top">üèÜ TOP</span>` : ``}
      <br>
      Satƒ±≈ü: ${e.s ?? "-"}<br>
      üéØ H…ôd…ôf: ${e.h.toLocaleString()} AZN<br>
      Say: ${e.c ?? "-"}<br>
      H…ôd…ôf icra: ${e.t ?? "-"}<br>
      Portfel: 330,000 AZN<br>
      PAR30+: ${e.p ?? "-"}
    </div>
  `).join("");

  // PIE
  const total = toNum(d.TotalTarget);
  const actual = toNum(d.TotalActual);
  const percent = total ? ((actual/total)*100).toFixed(1) : "0.0";

  document.getElementById("totalPercent").innerText = percent + "%";
  document.getElementById("totalTargetText").innerText = total.toLocaleString() + " AZN";

  if(pieChart) pieChart.destroy();
  pieChart = new Chart(document.getElementById("targetPie"),{
    type:"doughnut",
    data:{
      labels:["ƒ∞cra","Qalƒ±q"],
      datasets:[{
        data:[actual, Math.max(0, total-actual)],
        backgroundColor:["#2563eb","#e5e7eb"],
        borderWidth:0
      }]
    },
    options:{cutout:"70%"}
  });

  // ≈ûƒ∞RK∆èTL∆èR (d burada var dey…ô loadData i√ßind…ô olmalƒ±dƒ±r)
  const companies = [
    ["MyShops", d.MyShopsPortfolio, d.MyShopsPar],
    ["MyCars", d.MyCarsPortfolio, d.MyCarsPar],
    ["MyParfume", d.MyParfumePortfolio, d.MyParfumePar],
    ["MyMobile", d.MyMobilePortfolio, d.MyMobilePar]
  ];

  document.getElementById("companyTable").innerHTML = companies.map(c=>`
    <tr>
      <td>${c[0]}</td>
      <td>${toNum(c[1]).toLocaleString()} AZN</td>
      <td>${c[2] ?? "-"}</td>
    </tr>
  `).join("");
}

loadData();
setInterval(loadData, 5*60*1000);
// üîÑ YENƒ∞L∆è
document.getElementById("btnRefresh").addEventListener("click", loadData);

// üì§ PNG EXPORT
document.getElementById("btnPNG").addEventListener("click", async ()=>{
  const canvas = await html2canvas(document.getElementById("dashboard"), {scale:2});
  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/png");
  a.download = "dashboard.png";
  a.click();
});

// üìÑ PDF EXPORT
document.getElementById("btnPDF").addEventListener("click", async ()=>{
  const canvas = await html2canvas(document.getElementById("dashboard"), {scale:2});
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","mm","a4");
  const w = pdf.internal.pageSize.getWidth();
  const h = (canvas.height * w) / canvas.width;
  pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, 0, w, h);
  pdf.save("dashboard.pdf");
});
// ===== COLLAPSE LOGIC =====
document.querySelectorAll(".card h3").forEach(h3=>{
  h3.addEventListener("click", ()=>{
    h3.parentElement.classList.toggle("collapsed");
  });
});

</script>

</body>
</html>
