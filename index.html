<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<title>Telegram Statistikası Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;padding:20px;font-family:Arial;background:#f4f6f9}
h1{margin:0;font-size:20px}
.card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:16px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.kpi{border:1px solid #eee;border-radius:10px;padding:12px}
.kpi .l{font-size:12px;color:#6b7280}
.kpi .v{font-size:18px;font-weight:bold;margin-top:6px}
.experts{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.expert{border:1px solid #eee;border-radius:10px;padding:12px;font-size:14px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #eee;padding:8px;text-align:left}
th{color:#6b7280}
#targetPie{
  max-width: 240px;
  max-height: 240px;
  margin: 0 auto;
}

</style>
</head>

<body>

<h1>Telegram Statistikası Dashboard</h1>
<p>Tarix: <b id="today"></b></p>

<div class="card">
<h3>Portfel göstəriciləri</h3>
<div class="kpis" id="mainKpi"></div>
</div>

<div class="card">
<h3>Satış</h3>
<div class="kpis" id="salesKpi"></div>
</div>

<div class="card">
<h3>Mütəxəssis satışı</h3>
<div class="experts" id="experts"></div>
</div>

<div class="card">

<h3>Ümumi hədəf icrası</h3>
<div style="text-align:center;margin-bottom:12px">
  <div style="font-size:14px;color:#64748b">
    Ümumi icra faizi
  </div>
  <div id="totalPercent" style="font-size:26px;font-weight:800">
    --
  </div>
  <div style="font-size:13px;color:#64748b;margin-top:6px">

    Ümumi hədəf: <b id="totalTargetText">--</b>
  </div>
</div>


<canvas id="targetPie"></canvas>
</div>

<div class="card">
<h3>Şirkətlər üzrə portfel</h3>
<table>
<thead>
<tr><th>Şirkət</th><th>Aktiv portfel</th><th>PAR30+</th></tr>
</thead>
<tbody id="companyTable"></tbody>
</table>
</div>

<script>
const SHEET =
"https://opensheet.elk.sh/17qXOuePLlCtB8Z-J5e7xISkJ0VybGuAVZSxPTXq4ilc/Sheet5";

document.getElementById("today").innerText =
new Date().toLocaleDateString("az-AZ");

fetch(SHEET).then(r=>r.json()).then(rows=>{
const d = rows[0];

/* ==== PORTFEL KPI ==== */
const diff = Number(d.PortfolioDiff);
const icon = diff>0?"⬆️":diff<0?"⬇️":"";
document.getElementById("mainKpi").innerHTML = `
<div class="kpi"><div class="l">Portfel</div><div class="v">
${Number(d.Portfolio).toLocaleString()} AZN (${icon} ${Math.abs(diff)}%)
</div></div>
<div class="kpi"><div class="l">PAR30+</div><div class="v">${d.Par30}</div></div>
<div class="kpi"><div class="l">Marja</div><div class="v">${d.Marja}</div></div>
`;

/* ==== SATIŞ KPI ==== */
document.getElementById("salesKpi").innerHTML = `
<div class="kpi"><div class="l">Hissəli ödəniş</div><div class="v">${Number(d.InstallmentAmount).toLocaleString()} AZN</div></div>
<div class="kpi"><div class="l">İlkin ödəniş</div><div class="v">${Number(d.FirstPayment).toLocaleString()} AZN</div></div>
<div class="kpi"><div class="l">Ümumi məbləğ</div><div class="v">${Number(d.TotalAmount).toLocaleString()} AZN</div></div>
`;

/* ==== MÜTƏXƏSSİSLƏR ==== */
const experts = [
{n:d.Expert1,s:d.ExpertSale1,c:d.ExpertCount1,t:d.ExpertTarget1,p:d.ExpertPar1},
{n:d.Expert2,s:d.ExpertSale2,c:d.ExpertCount2,t:d.ExpertTarget2,p:d.ExpertPar2},
{n:d.Expert3,s:d.ExpertSale3,c:d.ExpertCount3,t:d.ExpertTarget3,p:d.ExpertPar3}
];
const box=document.getElementById("experts"); box.innerHTML="";
experts.forEach(e=>{
box.innerHTML+=`
<div class="expert">
<b>${e.n}</b><br>
Satış: ${e.s}<br>
Say: ${e.c}<br>
Hədəf icra: ${e.t}<br>
Portfel: 330,000 AZN<br>
PAR30+: ${e.p}
</div>`;
});

/* ==== PIE ==== */
/* ==== ƏTRAFLI PIE / DONUT ==== */
const total = Number(d.TotalTarget);
const actual = Number(d.TotalActual);

const percent = total > 0
  ? ((actual / total) * 100).toFixed(1)
  : 0;

// MƏTN KPI-lar
document.getElementById("totalPercent").innerText = percent + "%";
document.getElementById("totalTargetText").innerText =
  total.toLocaleString() + " AZN";

new Chart(document.getElementById("targetPie"), {
  type: "doughnut",
  data: {
    labels: ["İcra olunub", "Qalıq"],
    datasets: [{
      data: [actual, total - actual],
      backgroundColor: ["#2563eb", "#e5e7eb"],
      borderWidth: 0
    }]
  },
  options: {
    cutout: "70%",
    plugins: {
      legend: {
        position: "bottom",
        labels: {
          boxWidth: 12,
          padding: 16
        }
      },
      tooltip: {
        callbacks: {
          label: ctx => {
            return ctx.label + ": " +
              ctx.parsed.toLocaleString() + " AZN";
          }
        }
      }
    }
  },
  plugins: [{
    id: "centerText",
    afterDraw(chart) {
      const {ctx, width, height} = chart;
      ctx.save();
      ctx.font = "bold 22px Segoe UI";
      ctx.fillStyle = "#111827";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(percent + "%", width / 2, height / 2);
      ctx.restore();
    }
  }]
});


/* ==== ŞİRKƏTLƏR ==== */
const companies=[
["MyShops",d.MyShopsPortfolio,d.MyShopsPar],
["MyCars",d.MyCarsPortfolio,d.MyCarsPar],
["MyParfume",d.MyParfumePortfolio,d.MyParfumePar],
["MyMobile",d.MyMobilePortfolio,d.MyMobilePar]
];
const t=document.getElementById("companyTable");
companies.forEach(c=>{
t.innerHTML+=`<tr><td>${c[0]}</td><td>${Number(c[1]).toLocaleString()} AZN</td><td>${c[2]}</td></tr>`;
});
});
</script>

</body>
</html>
