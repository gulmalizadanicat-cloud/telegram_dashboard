<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<title>Telegram Statistikasƒ± Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Export √º√ß√ºn -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
/* ===== BASE ===== */
body{margin:0;padding:20px;font-family:Arial;background:#f4f6f9}
h1{margin:0 0 8px;font-size:20px}
.card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:16px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.kpi{border:1px solid #eee;border-radius:10px;padding:12px}
.kpi .l{font-size:12px;color:#6b7280}
.kpi .v{font-size:18px;font-weight:bold;margin-top:6px}
.experts{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.expert{border:1px solid #eee;border-radius:10px;padding:12px;font-size:14px}
table{width:100%;border-collapse:collapse;min-width:480px}
th,td{border-bottom:1px solid #eee;padding:8px;text-align:left}
th{color:#6b7280}

/* ===== PIE ===== */
#targetPie{max-width:240px;max-height:240px;margin:0 auto;display:block}

/* ===== TABLE SCROLL ===== */
.table-wrap{width:100%;overflow-x:auto}

/* ===== KPI STATUS ===== */
.kpi.green{background:#ecfdf5;border-color:#10b981}
.kpi.yellow{background:#fffbeb;border-color:#f59e0b}
.kpi.red{background:#fef2f2;border-color:#ef4444}

/* ===== COLLAPSE ===== */
.card h3{cursor:pointer}
.card-body{margin-top:8px}
.card.collapsed .card-body{display:none}

/* ===== TOP BADGE ===== */
.badge{
  display:inline-block;
  padding:2px 8px;
  font-size:12px;
  border-radius:999px;
  margin-left:8px;
  vertical-align:middle;
  border:1px solid #e5e7eb;
  background:#f8fafc;
  color:#0f172a;
}
.badge.top{
  background:#fff7ed;
  border-color:#fdba74;
}

/* ===== HEADER ACTIONS ===== */
.topbar{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  margin-bottom:6px;
}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{
  border:1px solid #e5e7eb;
  background:#fff;
  border-radius:10px;
  padding:8px 10px;
  font-size:13px;
  cursor:pointer;
}
.btn:hover{background:#f8fafc}
.muted{color:#6b7280;font-size:12px}

/* Export √º√ß√ºn: b√ºt√ºn dashboard sah…ôsi */
#dashboard{max-width:1100px;margin:0 auto}

/* ===== MOBILE ===== */
@media (max-width:768px){
  body{padding:10px;-webkit-text-size-adjust:100%}
  h1{font-size:18px}
  h3{font-size:15px}
  .card{padding:12px;border-radius:10px}
  .kpis{grid-template-columns:repeat(2,1fr)}
  .kpi .v{font-size:15px}
  .experts{grid-template-columns:1fr}
  .expert{font-size:13px;line-height:1.5;background:#fafafa}
  #targetPie{max-width:200px;max-height:200px}
  #totalPercent{font-size:22px!important}
  table{font-size:13px}
}
</style>
</head>

<body>

<div id="dashboard">
  <div class="topbar">
    <div>
      <h1>Telegram Statistikasƒ± Dashboard</h1>
      <p>Tarix: <b id="today"></b> <span class="muted" id="lastUpdate"></span></p>
    </div>
    <div class="actions">
      <button class="btn" id="btnRefresh">üîÑ Yenil…ô</button>
      <button class="btn" id="btnPNG">üì§ PNG</button>
      <button class="btn" id="btnPDF">üìÑ PDF</button>
    </div>
  </div>

  <div class="card">
    <h3>Portfel g√∂st…ôricil…ôri</h3>
    <div class="card-body">
      <div class="kpis" id="mainKpi"></div>
    </div>
  </div>

  <div class="card">
    <h3>Satƒ±≈ü</h3>
    <div class="card-body">
      <div class="kpis" id="salesKpi"></div>
    </div>
  </div>

  <div class="card">
    <h3>M√ºt…ôx…ôssis satƒ±≈üƒ±</h3>
    <div class="card-body">
      <div class="experts" id="experts"></div>
    </div>
  </div>

  <div class="card">
    <h3>√úmumi h…ôd…ôf icrasƒ±</h3>
    <div class="card-body" style="text-align:center">
      <div style="font-size:14px;color:#64748b">√úmumi icra faizi</div>
      <div id="totalPercent" style="font-size:26px;font-weight:800">--</div>
      <div style="font-size:13px;color:#64748b;margin-bottom:8px">
        √úmumi h…ôd…ôf: <b id="totalTargetText">--</b>
      </div>
      <canvas id="targetPie"></canvas>
    </div>
  </div>

  <div class="card">
    <h3>≈ûirk…ôtl…ôr √ºzr…ô portfel</h3>
    <div class="card-body table-wrap">
      <table>
        <thead>
          <tr><th>≈ûirk…ôt</th><th>Aktiv portfel</th><th>PAR30+</th></tr>
        </thead>
        <tbody id="companyTable"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const SHEET="https://opensheet.elk.sh/17qXOuePLlCtB8Z-J5e7xISkJ0VybGuAVZSxPTXq4ilc/Sheet5";

document.getElementById("today").innerText = new Date().toLocaleDateString("az-AZ");

// chart instance saxlayƒ±rƒ±q ki, refresh-d…ô destroy ed…ôk
let pieChart = null;

function toNum(x){
  // "12,345.67", "12 345", "12.3%" kimi hallarƒ± t…ômizl…ôyir
  if(x === null || x === undefined) return 0;
  const s = String(x).replace(/\s/g,'').replace(/,/g,'').replace('%','');
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}

async function loadData(){
  const lastUpdate = document.getElementById("lastUpdate");
  lastUpdate.textContent = "¬∑ yenil…ônir...";

  const rows = await fetch(SHEET, {cache:"no-store"}).then(r=>r.json());
  const d = rows[0];

  lastUpdate.textContent = "¬∑ son yenil…ônm…ô: " + new Date().toLocaleTimeString("az-AZ");

  /* KPI */
  const diff = toNum(d.PortfolioDiff);
  const icon = diff>0 ? "‚¨ÜÔ∏è" : diff<0 ? "‚¨áÔ∏è" : "‚ûñ";

  document.getElementById("mainKpi").innerHTML = `
    <div class="kpi">
      <div class="l">Portfel</div>
      <div class="v">${toNum(d.Portfolio).toLocaleString()} AZN (${icon} ${Math.abs(diff)}%)</div>
    </div>
    <div class="kpi"><div class="l">PAR30+</div><div class="v">${d.Par30}</div></div>
    <div class="kpi"><div class="l">Marja</div><div class="v">${d.Marja}</div></div>
  `;

  /* KPI colors */
  const kpis = document.querySelectorAll("#mainKpi .kpi");
  // Portfel diff
  if(diff >= 5) kpis[0].classList.add("green");
  else if(diff >= 0) kpis[0].classList.add("yellow");
  else kpis[0].classList.add("red");

  // PAR30+
  const par = toNum(d.Par30);
  if(par <= 3) kpis[1].classList.add("green");
  else if(par <= 6) kpis[1].classList.add("yellow");
  else kpis[1].classList.add("red");

  /* Sales */
  document.getElementById("salesKpi").innerHTML = `
    <div class="kpi"><div class="l">Hiss…ôli √∂d…ôni≈ü</div><div class="v">${toNum(d.InstallmentAmount).toLocaleString()} AZN</div></div>
    <div class="kpi"><div class="l">ƒ∞lkin √∂d…ôni≈ü</div><div class="v">${toNum(d.FirstPayment).toLocaleString()} AZN</div></div>
    <div class="kpi"><div class="l">√úmumi m…ôbl…ôƒü</div><div class="v">${toNum(d.TotalAmount).toLocaleString()} AZN</div></div>
  `;

  /* Experts + TOP badge */
  const experts = [
    {n:d.Expert1, s:d.ExpertSale1, c:d.ExpertCount1, t:d.ExpertTarget1, p:d.ExpertPar1},
    {n:d.Expert2, s:d.ExpertSale2, c:d.ExpertCount2, t:d.ExpertTarget2, p:d.ExpertPar2},
    {n:d.Expert3, s:d.ExpertSale3, c:d.ExpertCount3, t:d.ExpertTarget3, p:d.ExpertPar3}
  ];

  // TOP m√ºt…ôx…ôssis: satƒ±≈ü (s) …ôn b√∂y√ºk olan
  const salesNums = experts.map(e => toNum(e.s));
  const topIdx = salesNums.indexOf(Math.max(...salesNums));

  document.getElementById("experts").innerHTML = experts.map((e,i)=>`
    <div class="expert">
      <b>${e.n || "-"}</b>
      ${i===topIdx ? `<span class="badge top">üèÜ TOP</span>` : ``}
      <br>
      Satƒ±≈ü: ${e.s}<br>
      Say: ${e.c}<br>
      H…ôd…ôf icra: ${e.t}<br>
      Portfel: 330,000 AZN<br>
      PAR30+: ${e.p}
    </div>
  `).join("");

  /* PIE */
  const total = toNum(d.TotalTarget);
  const actual = toNum(d.TotalActual);
  const percent = total > 0 ? ((actual/total)*100).toFixed(1) : "0.0";

  document.getElementById("totalPercent").innerText = percent + "%";
  document.getElementById("totalTargetText").innerText = total.toLocaleString() + " AZN";

  let pieColor = "#2563eb";
  if(Number(percent) >= 90) pieColor = "#16a34a";
  else if(Number(percent) < 70) pieColor = "#dc2626";

  // refresh zamanƒ± k√∂hn…ô chartƒ± sil
  if(pieChart) pieChart.destroy();

  pieChart = new Chart(document.getElementById("targetPie"), {
    type: "doughnut",
    data: {
      labels: ["ƒ∞cra", "Qalƒ±q"],
      datasets: [{
        data: [actual, Math.max(0, total-actual)],
        backgroundColor: [pieColor, "#e5e7eb"],
        borderWidth: 0
      }]
    },
    options: {
      cutout: "70%",
      plugins: { legend: { position: "bottom" } }
    }
  });

  /* Companies */
  const companies = [
    ["MyShops", d.MyShopsPortfolio, d.MyShopsPar],
    ["MyCars", d.MyCarsPortfolio, d.MyCarsPar],
    ["MyParfume", d.MyParfumePortfolio, d.MyParfumePar],
    ["MyMobile", d.MyMobilePortfolio, d.MyMobilePar]
  ];
  document.getElementById("companyTable").innerHTML = companies.map(c=>`
    <tr>
      <td>${c[0]}</td>
      <td>${toNum(c[1]).toLocaleString()} AZN</td>
      <td>${c[2]}</td>
    </tr>
  `).join("");

  /* Collapse (mobil) */
  if(window.innerWidth <= 768){
    document.querySelectorAll(".card").forEach(card=>{
      if(!card.dataset.collapseReady){
        card.dataset.collapseReady = "1";
        card.classList.add("collapsed");
        card.querySelector("h3").onclick = () => card.classList.toggle("collapsed");
      }
    });
  }
}

// ƒ∞lk y√ºkl…ôm…ô
loadData();

// Manual refresh
document.getElementById("btnRefresh").addEventListener("click", loadData);

// Auto refresh (5 d…ôqiq…ô)
setInterval(loadData, 5 * 60 * 1000);

/* ===== Export PNG / PDF ===== */
async function exportPNG(){
  const el = document.getElementById("dashboard");
  const canvas = await html2canvas(el, {scale: 2, backgroundColor: "#f4f6f9"});
  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/png");
  a.download = "telegram-dashboard.png";
  a.click();
}

async function exportPDF(){
  const el = document.getElementById("dashboard");
  const canvas = await html2canvas(el, {scale: 2, backgroundColor: "#f4f6f9"});
  const imgData = canvas.toDataURL("image/png");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","mm","a4");

  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  // ≈ü…ôkli A4-…ô sƒ±ƒüƒ±≈üdƒ±r
  const imgProps = pdf.getImageProperties(imgData);
  const imgWidth = pageWidth;
  const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

  if(imgHeight <= pageHeight){
    pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
  } else {
    // √ßox uzundursa s…ôhif…ôl…ôr…ô b√∂l
    let y = 0;
    let remainingHeight = imgHeight;

    while(remainingHeight > 0){
      pdf.addImage(imgData, "PNG", 0, y, imgWidth, imgHeight);
      remainingHeight -= pageHeight;
      if(remainingHeight > 0){
        pdf.addPage();
        y -= pageHeight;
      }
    }
  }

  pdf.save("telegram-dashboard.pdf");
}

document.getElementById("btnPNG").addEventListener("click", exportPNG);
document.getElementById("btnPDF").addEventListener("click", exportPDF);
</script>

</body>
</html>
