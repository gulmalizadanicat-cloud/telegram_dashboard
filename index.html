<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <title>MyGroup Kredit | Ultra Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --primary-blue: #0b3ea8;
            --accent-blue: #2563eb;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --success: #16a34a;
            --warning: #f59e0b;
            --danger: #dc2626;
            --glass-border: rgba(255, 255, 255, 0.7);
        }

        .dark-mode {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --primary-blue: #3b82f6;
            --accent-blue: #60a5fa;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0; padding: 20px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            transition: background 0.3s, color 0.3s;
        }

        #dashboard { max-width: 1200px; margin: 0 auto; }

        .header-box {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        h1 {
            font-size: 32px; font-weight: 800; margin: 0; color: var(--primary-blue);
            letter-spacing: -0.5px;
            display: inline-block;
        }

        .live-indicator {
            background: var(--success); color: white; padding: 4px 12px;
            border-radius: 20px; font-size: 11px; font-weight: 800;
            margin-left: 10px; vertical-align: middle; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .date-container {
            margin-top: 5px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .main-container {
            background: var(--card-bg); border-radius: 24px; padding: 32px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.06);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }

        .section-header {
            font-size: 18px; font-weight: 800; color: var(--primary-blue);
            margin: 25px 0 15px 0; display: flex; justify-content: space-between;
            align-items: center; cursor: pointer; user-select: none;
            padding: 10px; border-bottom: 2px solid rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .section-header:hover { background: rgba(0,0,0,0.02); border-radius: 8px; }

        .section-header::after { content: '‚ñº'; font-size: 12px; transition: transform 0.3s; }
        .collapsed .section-header::after { transform: rotate(-90deg); }
        .collapsed .section-content { display: none; }

        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .kpi-box {
            background: rgba(0,0,0,0.02); padding: 20px; border-radius: 16px;
            border: 1px solid rgba(0,0,0,0.05); transition: all 0.3s;
        }
        .kpi-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        .kpi-val { font-size: 22px; font-weight: 800; margin-top: 8px; color: var(--primary-blue); }

        .expert-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .expert-card {
            background: var(--card-bg); border-radius: 16px; padding: 20px;
            border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }

        .progress-container { height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden; margin: 12px 0; }
        .progress-fill { height: 100%; transition: width 1.5s cubic-bezier(0.1, 0, 0.1, 1); }

        .charts-row { display: grid; grid-template-columns: 350px 1fr; gap: 30px; align-items: center; }
        .chart-box-inner { background: rgba(0,0,0,0.02); padding: 20px; border-radius: 20px; position: relative; }

        .top-actions { position: fixed; top: 15px; right: 15px; z-index: 1001; display: flex; gap: 8px; }
        .top-actions button {
            background: var(--card-bg); border: 1px solid var(--accent-blue); padding: 8px 16px;
            border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 13px;
            color: var(--text-main); box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .top-actions button:hover { background: var(--accent-blue); color: white; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: var(--text-muted); font-size: 11px; text-transform: uppercase; border-bottom: 2px solid rgba(0,0,0,0.05); }
        td { padding: 14px 12px; border-bottom: 1px solid rgba(0,0,0,0.05); font-weight: 600; }

        .gauge-text-container {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); text-align: center;
        }

        @media (max-width: 900px) {
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .expert-grid, .charts-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="top-actions">
    <button onclick="document.body.classList.toggle('dark-mode')">üåì Rejim</button>
    <button id="btnRefresh">üîÑ Yenil…ô</button>
    <button id="btnPDF">üìÑ PDF Y√ºkl…ô</button>
</div>

<div id="dashboard">
    <div class="header-box">
        <div>
            <p style="color: var(--text-muted); font-weight: 700; margin: 0; font-size: 12px; text-transform: uppercase;">MyGroup Holding</p>
            <h1>MyGroup Kredit <span class="live-indicator">LIVE</span></h1>
            <div class="date-container">
                üìÖ Tarix: <span id="today">--.--.----</span> | üïí <span id="lastUpdate">Y√ºkl…ônir...</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="collapsible-section">
            <div class="section-header">ƒ∞cmal Hesabatƒ±</div>
            <div class="section-content">
                <div id="summaryText" style="line-height: 1.6; font-size: 15px; color: var(--text-main); margin-bottom: 20px; padding: 15px; background: rgba(37, 99, 235, 0.05); border-radius: 12px; border-left: 4px solid var(--accent-blue);">
                    M…ôlumatlar t…ôhlil edilir...
                </div>
            </div>
        </div>

        <div class="collapsible-section">
            <div class="section-header">Portfel G√∂st…ôricil…ôri</div>
            <div class="section-content">
                <div class="kpi-grid" id="mainKpi"></div>
            </div>
        </div>

        <div class="collapsible-section">
            <div class="section-header">√úmumi h…ôd…ôf icrasƒ± v…ô 2025 trend</div>
            <div class="section-content">
                <div class="charts-row">
                    <div class="chart-box-inner" style="height: 250px;">
                        <canvas id="targetGauge"></canvas>
                        <div class="gauge-text-container">
                            <div id="gaugeLabel" style="font-size: 28px; font-weight: 900; color: var(--primary-blue);">0%</div>
                            <div style="margin-top: 5px; font-weight: 700; font-size: 12px; color: var(--text-muted);">H…ôd…ôf: <br><span id="totalTargetText">-</span></div>
                        </div>
                    </div>
                    <div class="chart-box-inner">
                        <canvas id="installmentLine"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="collapsible-section">
            <div class="section-header">M√ºt…ôx…ôssis Performansƒ±</div>
            <div class="section-content">
                <div class="expert-grid" id="experts"></div>
            </div>
        </div>

        <div class="collapsible-section">
            <div class="section-header">≈ûirk…ôtl…ôr √ºzr…ô b√∂lg√º</div>
            <div class="section-content">
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>≈ûirk…ôt Adƒ±</th>
                                <th>Aktiv Portfel</th>
                                <th>Gecikm…ô (PAR30+)</th>
                            </tr>
                        </thead>
                        <tbody id="companyTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SHEET = "https://opensheet.elk.sh/17qXOuePLlCtB8Z-J5e7xISkJ0VybGuAVZSxPTXq4ilc/Sheet5";
    const SHEET_TREND = "https://opensheet.elk.sh/17qXOuePLlCtB8Z-J5e7xISkJ0VybGuAVZSxPTXq4ilc/Installment_2025";

    let charts = {};
    document.getElementById("today").innerText = new Date().toLocaleDateString("az-AZ");

    // Collapsible Logic
    document.querySelectorAll('.section-header').forEach(header => {
        header.onclick = () => header.parentElement.classList.toggle('collapsed');
    });

    function toNum(x) {
        if (!x) return 0;
        return Number(String(x).replace(/\s/g,'').replace(/,/g,'').replace('%','')) || 0;
    }

    async function loadData() {
        try {
            const [rows, trendRows] = await Promise.all([
                fetch(SHEET, {cache:"no-store"}).then(r=>r.json()),
                fetch(SHEET_TREND, {cache:"no-store"}).then(r=>r.json())
            ]);
            
            const d = rows[0] || {};
            document.getElementById("lastUpdate").innerText = "Son yenil…ônm…ô: " + new Date().toLocaleTimeString("az-AZ");

            const diff = toNum(d.PortfolioDiff);
            const trendIcon = diff > 0 ? "‚Üë" : diff < 0 ? "‚Üì" : "‚Üí";
            
            // KPI Grid
            document.getElementById("mainKpi").innerHTML = `
                <div class="kpi-box" style="background: var(--primary-blue); color: white;">
                    <div class="kpi-label" style="color: rgba(255,255,255,0.7)">Aktiv Portfel</div>
                    <div class="kpi-val" style="color: white">${toNum(d.Portfolio).toLocaleString()} ‚Çº</div>
                    <div style="font-size: 11px; margin-top: 5px; font-weight: 700;">${trendIcon} ${Math.abs(diff)}%</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">PAR30+ Gecikm…ô</div>
                    <div class="kpi-val" style="color: ${toNum(d.Par30) > 5 ? 'var(--danger)' : 'var(--primary-blue)'}">${d.Par30 || "0%"}</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">Aylƒ±q Yƒ±ƒüƒ±m</div>
                    <div class="kpi-val">${toNum(d.MonthlyExpectedCollection).toLocaleString()} ‚Çº</div>
                </div>
                <div class="kpi-box">
                    <div class="kpi-label">√úmumi Satƒ±≈ü</div>
                    <div class="kpi-val">${toNum(d.TotalAmount).toLocaleString()} ‚Çº</div>
                </div>
            `;

            // Gauge Chart Fix
            const total = toNum(d.TotalTarget);
            const actual = toNum(d.TotalActual);
            const percent = total > 0 ? Math.min((actual / total) * 100, 100).toFixed(1) : 0;
            
            document.getElementById("gaugeLabel").innerText = percent + "%";
            document.getElementById("totalTargetText").innerText = total.toLocaleString() + " ‚Çº";

            if (charts.gauge) charts.gauge.destroy();
            charts.gauge = new Chart(document.getElementById("targetGauge"), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [percent, 100 - percent],
                        backgroundColor: ['#2563eb', '#e2e8f0'],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270,
                        cutout: '85%'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { tooltip: { enabled: false } } 
                }
            });

            // Trend Chart
            if (charts.line) charts.line.destroy();
            charts.line = new Chart(document.getElementById("installmentLine"), {
                type: 'line',
                data: {
                    labels: trendRows.map(r => r.Ay),
                    datasets: [{
                        label: 'Satƒ±≈ü',
                        data: trendRows.map(r => toNum(r.Hiss…ôli_Odenis)),
                        borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true, tension: 0.4, pointRadius: 4
                    }]
                },
                options: { responsive: true, plugins: { legend: {display: false} } }
            });

            // Expert Performance
            const experts = [
                {n:d.Expert1, s:toNum(d.ExpertSale1), t:toNum(d.ExpertTarget1), h:toNum(d.Expert1Target)},
                {n:d.Expert2, s:toNum(d.ExpertSale2), t:toNum(d.ExpertTarget2), h:toNum(d.Expert2Target)},
                {n:d.Expert3, s:toNum(d.ExpertSale3), t:toNum(d.ExpertTarget3), h:toNum(d.Expert3Target)}
            ];
            document.getElementById("experts").innerHTML = experts.map(e => `
                <div class="expert-card">
                    <div style="font-weight: 800; margin-bottom:10px; color: var(--primary-blue);">${e.n || "M√ºt…ôx…ôssis"}</div>
                    <div style="font-size:13px; margin-bottom:5px;">Satƒ±≈ü: <b>${e.s.toLocaleString()} ‚Çº</b></div>
                    <div class="progress-container"><div class="progress-fill" style="width:${Math.min(e.t, 100)}%; background:#2563eb"></div></div>
                    <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:700;">
                        <span>ƒ∞CRA: ${e.t}%</span>
                        <span style="color:var(--text-muted)">H∆èD∆èF: ${e.h.toLocaleString()} ‚Çº</span>
                    </div>
                </div>`).join("");

            // Companies
            const cos = [
                ["MyShops", d.MyShopsPortfolio, d.MyShopsPar],
                ["MyCars", d.MyCarsPortfolio, d.MyCarsPar],
                ["MyParfume", d.MyParfumePortfolio, d.MyParfumePar],
                ["MyMobile", d.MyMobilePortfolio, d.MyMobilePar]
            ];
            document.getElementById("companyTable").innerHTML = cos.map(c => `
                <tr>
                    <td>${c[0]}</td>
                    <td>${toNum(c[1]).toLocaleString()} ‚Çº</td>
                    <td style="color:${toNum(c[2]) > 5 ? 'var(--danger)' : 'var(--success)'}">${c[2] || "0%"}</td>
                </tr>`).join("");

            document.getElementById("summaryText").innerHTML = `
                Aktiv portfel bu ay <b>${trendIcon} ${Math.abs(diff)}%</b> d…ôyi≈ü…ôr…ôk <b>${toNum(d.Portfolio).toLocaleString()} ‚Çº</b> olmu≈üdur. 
                √úmumi h…ôd…ôf icrasƒ± <b>${percent}%</b> t…ô≈ükil edir.
            `;

        } catch(e) { console.error("X…ôta:", e); }
    }

    // PDF Export Function
    document.getElementById("btnPDF").onclick = async () => {
        const { jsPDF } = window.jspdf;
        const btn = document.getElementById("btnPDF");
        const originalText = btn.innerText;
        btn.innerText = "Hazƒ±rlanƒ±r...";

        const canvas = await html2canvas(document.getElementById("dashboard"), {
            scale: 2,
            useCORS: true,
            backgroundColor: document.body.classList.contains('dark-mode') ? "#0f172a" : "#f0f4f8"
        });

        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`MyGroup_Kredit_Hesabat_${new Date().toLocaleDateString()}.pdf`);
        btn.innerText = originalText;
    };

    document.getElementById("btnRefresh").onclick = loadData;
    loadData();
</script>
</body>
</html>
